# Modified from `https://github.com/aurora-is-near/aurora-relayer/blob/master/docker-compose.yaml`.

version: "3"

networks:
  net:
    external: true
    driver: test

volumes:
  database:

services:
  # test driver container reference. We run the container externally instead because of IP address
  # additions used in the Cosmos nodes and problems with passing env variables.
  # test:
  #   container_name: test
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #     args:
  #       use_local_artifacts: ${USE_LOCAL_ARTIFACTS}
  #   environment:
  #     USE_LOCAL_ARTIFACTS: ${USE_LOCAL_ARTIFACTS}
  #   volumes:
  #     - ${VOLUME_ARGS}
  #   hostname: test
  #   depends_on:
  #     faucet:
  #       condition: service_started
  #   networks:
  #     - net
  #   entrypoint: ${RUN_ARGS}

  database:
    container_name: "${NEAR_ENV:-testnet}_database"
    networks:
      - net
    image: auroraisnear/relayer-database
    # restart: unless-stopped
    ports:
      - '127.0.0.1:5432:5432'
    volumes:
      - database:/var/lib/postgresql/data
  indexer:
    container_name: "${NEAR_ENV:-testnet}_indexer"
    image: auroraisnear/relayer-endpoint
    networks:
      - net
    # restart: unless-stopped
    init: true
    depends_on:
      - database
    environment:
      - WAIT_HOSTS=database:5432
      - WAIT_BEFORE=1
      - NEAR_ENV=${NEAR_ENV:-testnet}
      - NODE_ENV=${NEAR_ENV:-testnet}
      - NEAR_URL=http://test:3030
    volumes:
      - ./docker_assets/aurora_config:/srv/aurora/relayer/config
      - "${NEAR_CONFIG_VOLUME}"
    # extra_hosts:
    #   - host.docker.internal:host-gateway # See: https://stackoverflow.com/a/43541732
    entrypoint: ["sh", "-c", "util/indexer/indexer | node lib/indexer_backend.js"]
  endpoint:
    container_name: "${NEAR_ENV:-testnet}_endpoint"
    image: auroraisnear/relayer-endpoint
    networks:
      - net
    # restart: unless-stopped
    init: true
    depends_on:
      - database
    environment:
      - WAIT_HOSTS=database:5432
      - WAIT_BEFORE=1
      - NEAR_ENV=${NEAR_ENV:-testnet}
      - NODE_ENV=${NEAR_ENV:-testnet}
      - NEAR_URL=http://test:3030
    ports:
      - '127.0.0.1:8545:8545'
    volumes:
      - ./docker_assets/aurora_config:/srv/aurora/relayer/config
      - "${NEAR_CONFIG_VOLUME}"
    entrypoint: ["node", "lib/index.js"]
